id: 404
pagetitle: 'Fixing uploads with FileSluggy'
alias: fixing-uploads-with-filesluggy
parent: 1
introtext: ''
template: 2
menuindex: 246
createdby: 2
uri: posts/fixing-uploads-with-filesluggy
show_in_tree: 0
properties: '{"contentblocks":{"content":"[{\"layout\":3,\"content\":{\"col1\":[{\"value\":\"<p>At modmore we have 3 extras that use file uploads one way or another: ContentBlocks, Redactor and MoreGallery. The file upload utilities in these extras have all been built with the Media Sources API in MODX, allowing them to support different media source configurations, remote sources like Amazon S3 and plugins that fire on upload.<\/p><p>Unfortunately, some of those plugins change the name of the uploaded file (for sanitisation or SEO purposes), and for a long time we''ve been unable of supporting those plugins, like FileSluggy and filetranslit. <\/p>\",\"field\":2,\"settings\":[]},{\"value\":\"The Problem\",\"level\":\"h2\",\"field\":3,\"settings\":{}},{\"value\":\"<p>In our code, we call $source-&gt;uploadObjectsToContainer() with a prepared files array, and the path we determined it should go to inside the media source. The media source, whether that''s the file or Amazon S3 one, then takes care of the actual upload and returns a true (successful upload) or false (something went wrong). <\/p><p>As the upload happens, the OnFileManagerUpload event is fired by MODX, and plugins like FileSluggy are executed. If they determine the filename does not meet their requirements (for example it contains dashes, while underscores are preferred), the plugin calls $source-&gt;renameObject() with a new file name. This is where the problem happens, as our code doesn''t get a message that the file name was changed after upload. So we try to show an image with a name that no longer exists. Broken image. <\/p><p>For a long time we were unable of figuring out a workaround, until the guys at Sterc walked into modmore hq to check on the issue. Following a bit of a discussion and some source code digging, an epiphany happened and we finally found a fix. Since then we''ve updated our extras to fix the compatibility. As there might be other people out there (today or in six months from now) that need to deal with the same problem, I''d like to present you our solution. <\/p>\",\"field\":2,\"settings\":{}},{\"value\":\"The Solution\",\"level\":\"h2\",\"field\":3,\"settings\":{}},{\"value\":\"\",\"field\":2,\"settings\":{}}]},\"settings\":[],\"parent\":0,\"title\":\"\"}]","linear":[{"value":"<p>At modmore we have 3 extras that use file uploads one way or another: ContentBlocks, Redactor and MoreGallery. The file upload utilities in these extras have all been built with the Media Sources API in MODX, allowing them to support different media source configurations, remote sources like Amazon S3 and plugins that fire on upload.<\/p><p>Unfortunately, some of those plugins change the name of the uploaded file (for sanitisation or SEO purposes), and for a long time we''ve been unable of supporting those plugins, like FileSluggy and filetranslit. <\/p>","field":2,"settings":[]},{"value":"The Problem","level":"h2","field":3,"settings":[]},{"value":"<p>In our code, we call $source-&gt;uploadObjectsToContainer() with a prepared files array, and the path we determined it should go to inside the media source. The media source, whether that''s the file or Amazon S3 one, then takes care of the actual upload and returns a true (successful upload) or false (something went wrong). <\/p><p>As the upload happens, the OnFileManagerUpload event is fired by MODX, and plugins like FileSluggy are executed. If they determine the filename does not meet their requirements (for example it contains dashes, while underscores are preferred), the plugin calls $source-&gt;renameObject() with a new file name. This is where the problem happens, as our code doesn''t get a message that the file name was changed after upload. So we try to show an image with a name that no longer exists. Broken image. <\/p><p>For a long time we were unable of figuring out a workaround, until the guys at Sterc walked into modmore hq to check on the issue. Following a bit of a discussion and some source code digging, an epiphany happened and we finally found a fix. Since then we''ve updated our extras to fix the compatibility. As there might be other people out there (today or in six months from now) that need to deal with the same problem, I''d like to present you our solution. <\/p>","field":2,"settings":[]},{"value":"The Solution","level":"h2","field":3,"settings":[]},{"value":"","field":2,"settings":[]}],"fieldcounts":{"2":3,"3":2},"_isContentBlocks":true}}'
tvs:
    author: markhamstra
    disqus_id: ''
    preview.image: ''

-----

<div class="row   " >
    <div class="[[++default_article_column_classnames]]">
        <p>At modmore we have 3 extras that use file uploads one way or another: ContentBlocks, Redactor and MoreGallery. The file upload utilities in these extras have all been built with the Media Sources API in MODX, allowing them to support different media source configurations, remote sources like Amazon S3 and plugins that fire on upload.</p><p>Unfortunately, some of those plugins change the name of the uploaded file (for sanitisation or SEO purposes), and for a long time we've been unable of supporting those plugins, like FileSluggy and filetranslit. </p>

<h2>The Problem</h2>

<p>In our code, we call $source-&gt;uploadObjectsToContainer() with a prepared files array, and the path we determined it should go to inside the media source. The media source, whether that's the file or Amazon S3 one, then takes care of the actual upload and returns a true (successful upload) or false (something went wrong). </p><p>As the upload happens, the OnFileManagerUpload event is fired by MODX, and plugins like FileSluggy are executed. If they determine the filename does not meet their requirements (for example it contains dashes, while underscores are preferred), the plugin calls $source-&gt;renameObject() with a new file name. This is where the problem happens, as our code doesn't get a message that the file name was changed after upload. So we try to show an image with a name that no longer exists. Broken image. </p><p>For a long time we were unable of figuring out a workaround, until the guys at Sterc walked into modmore hq to check on the issue. Following a bit of a discussion and some source code digging, an epiphany happened and we finally found a fix. Since then we've updated our extras to fix the compatibility. As there might be other people out there (today or in six months from now) that need to deal with the same problem, I'd like to present you our solution. </p>

<h2>The Solution</h2>


    </div>
</div>