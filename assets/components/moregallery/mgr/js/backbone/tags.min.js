jQuery(function(e){var t={tag:'<div class="mgimagetag-wrapper" data-id="<%= cid %>" >   <span class="mgimagetag-tag"><%= tag_display %></span>   <a href="javascript:void(0);" class="delete">&times;</a></div>',tagOuter:'<p class="total"></p><ul></ul>'};moreGallery.Models.Tag=Backbone.Model.extend({defaults:{id:null,resource:MODx.request.id,image:0,tag:0,tag_id:0,tag_display:"",tag_createdon:0,tag_createdby:0},actions:{create:"mgr/imagetags/create",read:"mgr/imagetags/getlist",update:"mgr/imagetags/update","delete":"mgr/imagetags/remove",patch:"mgr/imagetags/update"},url:function(){return moreGallery.config.connector_url+"?resource="+MODx.request.id+"&image="+this.get("image")}});moreGallery.Views.Tag=Backbone.View.extend({tagName:"li",template:underscore.template(t.tag),events:{"click a.delete":"removeTag"},render:function(){var e=this.model.attributes;e.cid=this.model.cid;this.$el.html(this.template(e));return this},initialize:function(){this.listenTo(this.model,"change",this.render);this.listenTo(this.model,"destroy",this.remove)},removeTag:function(){var e=this;this.$el.animate({opacity:0},400,function(){e.model.destroy()});return!1}});moreGallery.Collections.Tag=Backbone.Collection.extend({model:moreGallery.Models.Tag,actions:{create:"mgr/imagetags/create",read:"mgr/imagetags/getlist",update:"mgr/imagetags/update","delete":"mgr/imagetags/remove",patch:"mgr/imagetags/update"},initialize:function(e){this.options=e},url:function(){return moreGallery.config.connector_url+"?resource="+MODx.request.id+"&image="+this.options.image}});moreGallery.Collections.AllTags=Backbone.Collection.extend({model:moreGallery.Models.Tag,actions:{create:"mgr/tags/create",read:"mgr/tags/getlist",update:"mgr/tags/update","delete":"mgr/tags/remove",patch:"mgr/tags/update"},initialize:function(e){this.options=e},url:function(){return moreGallery.config.connector_url}});moreGallery.Views.TagCollection=Backbone.View.extend({events:{"keypress input":"addNewTag","click button":"addNewTag"},initialize:function(e){e=e||{};this.image=e.image;this.collection=new moreGallery.Collections.Tag(e);this.input=this.$("input");this.button=this.$("button");this.list=this.$("ul");var t=this,n=new Bloodhound({prefetch:{url:moreGallery.config.connector_url+"?action=mgr/tags/getlist",ttl:0},datumTokenizer:function(e){return[e.display]},queryTokenizer:Bloodhound.tokenizers.whitespace});n.initialize();this.$("#mgimage-new-tag").typeahead(null,{name:"tags",source:n.ttAdapter(),displayKey:"display"}).on("typeahead:selected",function(n,r){t.collection.create({resource:MODx.request.id,image:e.image,tag:r.id,tag_display:r.display});t.input.typeahead("val","")});this.listenTo(this.collection,"add",this.addOne);this.listenTo(this.collection,"reset",this.addAll);this.listenTo(this.collection,"all",this.render);this.listenTo(this.collection,"sync",this.markLoaded);this.collection.fetch()},render:function(){},markLoaded:function(){jQuery(".mgimage-tags-loading").removeClass("mgimage-tags-loading")},addOne:function(e){var t=new moreGallery.Views.Tag({model:e});this.list.append(t.render().el)},addAll:function(){moreGallery.Collections.Tag.each(this.addOne,this)},addNewTag:function(e){if(e.type=="click"||e.keyCode==13){if(!this.input.val())return;if(!moreGallery.config.permissions.image_tags_new){alert(moreGallery.lang("new_tags_not_allowed"));return!1}this.collection.create({resource:MODx.request.id,image:this.image,tag:this.input.val(),tag_display:this.input.val()});this.input.val("");e.preventDefault()}}})});