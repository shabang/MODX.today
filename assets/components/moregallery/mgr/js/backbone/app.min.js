jQuery(function($){var importId=0,templates={image:'<div data-id="<%= cid %>" class="inner <% if (active) { %> image_active <% } else { %> image_inactive <% } %>"><div class="image-wrapper"><div class="image" style="background-image: url(<%= mgr_thumb %>);">   <div class="mask">       <div class="image-actions">       <a class="zoom mgsearchicon icon icon-search" href="javascript:void(0); //View full-size image" title="<%= moreGallery.lang("view_full_size_image") %>"></span>       <a class="activate mgtrashicon icon icon-eye" href="javascript:void(0); //<%= moreGallery.lang("activate_image") %>" title="<%= moreGallery.lang("activate_image") %>"></a>       <a class="deactivate mgtrashicon icon icon-eye-slash" href="javascript:void(0); //<%= moreGallery.lang("deactivate_image") %>" title="<%= moreGallery.lang("deactivate_image") %>"></a>       <a class="delete mgtrashicon icon icon-trash-o" href="javascript:void(0); //Delete this image" title="<%= moreGallery.lang("delete_image") %>"></a>       </div>   </div></div><div class="meta">   <p class="name"><%= name %></p>   <p class="filename"><%= filename %></p>   <a class="edit mgicon-pencil icon icon-pencil-square-o"></a></div><div class="uploadprogress">   <div class="uploading"></div>   <div class="filename"><%= filename %></div>   <div class="bar"></div></div></div></div>',appView:'<div class="mgresource-toolbar"><ul>   <li><a href="javascript: void(0);" id="mgresource-image-upload" title="<%= moreGallery.lang("upload_image") %>">   <span class="icon mgicon-upload icon-upload"></span>   <span class="headline"><%= moreGallery.lang("upload") %></span>   </a></li>   <li><a href="javascript: void(0);" id="mgresource-image-import" title="<%= moreGallery.lang("import_image") %>">   <span class="icon mgicon-download icon-download"></span>   <span class="headline"><%= moreGallery.lang("import") %></span>   </a></li>   <li><a href="javascript: void(0);" id="mgresource-image-refresh" title="<%= moreGallery.lang("refresh") %>">   <span class="icon mgicon-cycle icon-refresh"></span>   <!--<span class="headline"><%= moreGallery.lang("refresh") %></span>-->   </a></li>   <li id="mgresource-droparea">           <p><i class="mgicon-upload icon icon-upload"></i> <%= moreGallery.lang("drop_to_upload") %></p>   </li>   <li id="mgresource-stats">   <span id="mgresource-image-count">0</span> <%= moreGallery.lang("images_count") %>   </li></ul></div><div class="mgresource-loading spinner"></div><input id="mgresource-upload-input" type="file" multiple><div id="mgresource-modal-mask"></div><div id="mgresource-imagearea"><ul id="mgresource-imagelist"></ul></div><div id="mgresource-modal"></div>',modalImageView:'<div class="image-large">   <img id="mgimage-image" src="<%= file_url %>" alt="<%= filename %>" />   <div class="mgimage-crops"></div></div><div class="edit-form">   <a href="javascript:void(0);" class="close">&times;</a>   <h3><%= moreGallery.lang("edit_image_header") %></h3>   <label><%= moreGallery.lang("name_field") %> <br /><input type="text" id="mgimage-name" value="<%- name %>"></label><br />   <label for="mgimage-description"><%= moreGallery.lang("description") %></label> <br />   <textarea id="mgimage-description" rows="5"><%- description %></textarea> <br />   <div class="mgimage-tags">       <label for="mgimage-new-tag"><%= moreGallery.lang("tags") %></label>       <br />       <div class="mgimage-tags-holder mgimage-tags-loading">           <input type="text" id="mgimage-new-tag">           <button id="mgimage-add-new-tag"><%= moreGallery.lang("tags.add") %></button>           <ul></ul>           <div class="spinner"></div>       </div>   </div>   <label><%= moreGallery.lang("url") %> <br /><input type="text" id="mgimage-url" value="<%- url %>"></label>   <div class="edit-form-buttons">           <a href="javascript:void(0);" class="save">               <span class="headline"><%= moreGallery.lang("save") %></span>           </a>   </div></div>',modalImageTagView:'<li class="mgimage-tag" data-tag-id="<%= id %>">   <span class="mgimage-tag-remove">&times;</span>   <span class="mgimage-tag-display"><%= display %></span></li>',modalZoomView:'<div class="image-zoom">   <h3><%= name %></h3>   <a href="javascript:void(0);" class="close">&times;</a>   <img src="<%= file_url %>" alt="<%= filename %>" /></div>',cropView:'<div class="image-crop">   <a href="<%= thumbnail_url %>" target="_blank" class="image-crop-preview">       <img src="<%= thumbnail_url %>" alt="<%= key %>" >   </a>   <label><%= key_display %></label>   <button class="image-crop-edit" data-crop="<%= key %>"><%= moreGallery.lang("edit_crop") %></button>   <span class="image-crop-saving-spinner"></span> </div>',modalImport:'<div class="modal-import">   <a href="javascript:void(0);" class="close">&times;</a>   <h3>Import Images</h3>   <p>Choose import Source</p><ul class="options">   <li>       <a href="javascript:void(0);" class="import-from-gallery">Gallery</a>       <div class="content">           <select id="selection"><%= galleries %></select>       </div>   </li>   <li>       <a href="javascript:void(0);" class="import-from-file">File</a>   </li>   <li>       <a href="javascript:void(0);" class="import-from-file">Folder</a>   </li></ul></div>'};Backbone.sync=moreGallery.backboneSync;var Image=Backbone.Model.extend({defaults:{id:0,resource:MODx.request.id,filename:"",file:"",file_url:"",mgr_thumb:"",active:!0,name:"",description:"",url:"",sortorder:0,width:0,height:0,crops:""},actions:{create:"mgr/images/create",read:"mgr/images/getlist",update:"mgr/images/update","delete":"mgr/images/remove",patch:"mgr/images/update"},url:moreGallery.config.connector_url+"?resource="+MODx.request.id}),ImageView=Backbone.View.extend({tagName:"li",template:underscore.template(templates.image),events:{"click .meta":"startEdit","click a.delete":"removeItem","click a.activate":"toggleActive","click a.deactivate":"toggleActive","click .mask":"viewImage"},render:function(){var e=this.model.attributes;e.cid=this.model.cid;this.$el.html(this.template(e));return this},initialize:function(){this.listenTo(this.model,"change",this.render);this.listenTo(this.model,"destroy",this.remove);this.listenTo(this.model,"uploadComplete",this.uploadComplete)},startEdit:function(){this.model.trigger("startEdit",{model:this.model})},viewImage:function(){this.model.trigger("zoomImage",{model:this.model})},toggleActive:function(){this.model.set("active",!this.model.get("active"));this.model.save();return!1},removeItem:function(){if(confirm(moreGallery.lang("confirm_remove",{name:this.model.attributes.name}))){var e=this;this.$el.animate({opacity:0},800,function(){$(this).animate({width:0},400,function(){e.model.destroy()})})}return!1},uploadComplete:function(){var e=this,t=e.$el.find("> div");t.addClass("mgimage-upload-new").removeClass("mgimage-uploading");setTimeout(function(){t.removeClass("mgimage-upload-new")},2500)}}),ImageCollection=Backbone.Collection.extend({el:$("#mgresource-imagelist"),model:Image,actions:{create:"mgr/images/create",read:"mgr/images/getlist",update:"mgr/images/update","delete":"mgr/images/remove",patch:"mgr/images/update"},url:moreGallery.config.connector_url+"?resource="+MODx.request.id,render:function(){$(this.imageCount).html(this.length)},initialize:function(){this.listenTo(this,"add",this.addOne);this.listenTo(this,"add",this.render);this.listenTo(this,"remove",this.render)},addOne:function(e){var t=new ImageView({model:e});$(this.el.selector).append(t.render().el)}}),imageCollection=new ImageCollection;moreGallery.ImageAppView=Backbone.View.extend({appViewTemplate:underscore.template(templates.appView),modalViewTemplate:underscore.template(templates.modalImageView),modalZoomViewTemplate:underscore.template(templates.modalZoomView),modalImportTemplate:underscore.template(templates.modalImport),cropViewTemplate:underscore.template(templates.cropView),collection:imageCollection,imageCount:"#mgresource-image-count",rendered:!1,modal:null,modalSelector:"#mgresource-modal",modalMask:null,modalMaskSelector:"#mgresource-modal-mask",activeModelInModal:null,fileBrowser:null,dropZoneInitiated:!1,refresh:function(){this.startLoading();this.collection.fetch({success:this.doneLoading,error:this.doneLoading})},render:function(){if(!this.rendered){var e=this.appViewTemplate({});this.$el.html(e);var t=this,n=jQuery("#modx-header").height()+12;jQuery("#modx-content").find("> .x-panel-bwrap > .x-panel-body").scroll(function(){var e=t.$el.hasClass("fixed-toolbar"),r=t.$el.offset().top;!e&&r<n&&t.$el.addClass("fixed-toolbar");e&&r>n&&t.$el.removeClass("fixed-toolbar")});this.refresh();this.initializeUpload();this.rendered=!0}return this},initialize:function(){this.listenTo(this.collection,"sync",this.doSortable);this.listenTo(this.collection,"add",this.updateCount);this.listenTo(this.collection,"remove",this.updateCount);this.listenTo(this.collection,"startEdit",this.modelStartEdit);this.listenTo(this.collection,"stopEdit",this.modelStopEdit);this.listenTo(this.collection,"zoomImage",this.zoomImage)},events:{"click #mgresource-image-refresh":"refresh","click #mgresource-image-upload":function(){$("#mgresource-upload-input").trigger("click")},"click #mgresource-image-import":"importFromFile",updateSort:"updateSort","click #mgresource-modal-mask":"modelStopEdit","click #mgresource-modal .close":"modelStopEdit","blur #mgresource-modal .edit-form input, #mgresource-modal .edit-form textarea":"updateFromModal","click #mgresource-modal .save":"updateFromModal","click .modal-import .import-from-file":"importFromFile"},openImportModal:function(e){var t={attributes:{galleries:'<option value="1">Gallery Uno</option><option value="2">Gallery Deux</option><option value="3">Gallery Trois</option>'}};this.openModal(this.modalImportTemplate,t,"50%")},importFromFile:function(e){var appView=this;this.fileBrowser||(this.fileBrowser=MODx.load({xtype:"modx-browser",onSelect:function(data){with(appView)appView.importFromFileSelect(data)},allowedFileTypes:"jpg,jpeg,png,gif",hideFiles:!0,title:moreGallery.lang("import_image"),source:moreGallery.getResourceProperty(moreGallery.ResourceRecord,"source",moreGallery.config.source)}));this.fileBrowser.show()},importFromFileSelect:function(e){importId++;var t=new Image({id:"import_"+importId,filename:e.name,mgr_thumb:moreGallery.config.assets_url+"mgr/img/importing.png",file_url:moreGallery.config.assets_url+"mgr/img/importing.png",name:e.name,sortorder:this.collection.length});this.collection.add(t);var n={tmpid:"import_"+importId,cid:t.cid,file:e.pathname,filename:e.name,resource:MODx.request.id},r=this;jQuery.ajax({url:moreGallery.config.connector_url+"?action=mgr/images/import_file",data:n,dataType:"json",type:"POST",success:function(e,r,i){if(e.success){var s=e.object;jQuery.each(s,function(e,n){t.set(e,n)});t.trigger("uploadComplete")}else{alert(moreGallery.lang("upload_error",{file:n.filename,message:e.message}));t.trigger("destroy")}},error:function(e,r,i){alert(moreGallery.lang("upload_error",{file:n.filename,message:r+" ("+i+")"}));t.trigger("destroy")}})},modelStartEdit:function(data){this.openModal(this.modalViewTemplate,data.model);if(MODx&&MODx.loadRTE&&moreGallery.config.use_rte_for_images){var appView=this;MODx.loadRTE("mgimage-description");setTimeout(function(){with(appView)appView.fixContainerHeight()},150)}$("#mgimage-name, #mgimage-url").on("keydown",function(e){e.keyCode==13&&e.preventDefault()});var imageTags=new moreGallery.Views.TagCollection({el:$(".mgimage-tags-holder"),image:data.model.id}),cropsHolder=$(".mgimage-crops"),currentCrops=Ext.decode(data.model.attributes.crops)||{},that=this,jcrop_api;this.displayCrops(cropsHolder,currentCrops,this);cropsHolder.on("click",".image-crop-edit",function(){var e=$(this),t=e.data("crop"),n=moreGallery.crops[t],r=e.text();if(r==moreGallery.lang("save_crop")){var i=jcrop_api.tellSelect(),s=e.siblings(".image-crop-saving-spinner");e.attr("disabled",!0).text(moreGallery.lang("processing_crop"));s.addClass("spinner");jcrop_api.release();jcrop_api.disable();$.each(i,function(e,t){i[e]=Math.round(t)});currentCrops[t].x=i.x;currentCrops[t].y=i.y;currentCrops[t].x2=i.x2;currentCrops[t].y2=i.y2;currentCrops[t].width=i.w;currentCrops[t].height=i.h;var o=Ext.encode(currentCrops);data.model.set("crops",o);data.model.save(null,{success:function(t,n,r){var i=Ext.decode(t.attributes.crops)||{};that.displayCrops(cropsHolder,i,that);e.text(moreGallery.lang("edit_crop"));cropsHolder.find("button").removeAttr("disabled");s.removeClass("spinner")}})}else{cropsHolder.find("button").attr("disabled",!0);e.text(moreGallery.lang("save_crop")).removeAttr("disabled");currentCrops[t]&&currentCrops[t].width>0&&jcrop_api.setSelect([currentCrops[t].x,currentCrops[t].y,currentCrops[t].x2,currentCrops[t].y2]);jcrop_api.setOptions({aspectRatio:n.aspect?n.aspect:null,minSize:[n.min_width?n.min_width:0,n.min_height?n.min_height:0]});jcrop_api.enable()}});this.$("#mgimage-image").Jcrop({trueSize:[data.model.attributes.width,data.model.attributes.height],keySupport:!1},function(){jcrop_api=this;jcrop_api.disable()});if(!this.dropZoneInitiated){this.dropZoneInitiated=!0;new MODx.load({xtype:"modx-treedrop",target:this.$("#mgimage-url"),targetEl:this.$("#mgimage-url")[0]})}},displayCrops:function(e,t,n){e.empty();$.each(moreGallery.crops,function(r,i){i=$.extend({},i,t[r]||{});i.key=r;i.thumbnail_url=i.thumbnail_url+"?hash="+i.thumbnail_hash;i.key_display=_("crop_name."+r)||r;e.append(n.cropViewTemplate(i))})},zoomImage:function(e){this.openModal(this.modalZoomViewTemplate,e.model)},openModal:function(e,t,n){n=n||"80%";this.modalMask||(this.modalMask=this.$(this.modalMaskSelector));this.activeModelInModal=t;var r=e(t.attributes);this.modal=this.$(this.modalSelector).html(r);this.modal.css("width",n);this.modalMask.fadeIn();this.modal.fadeIn();this.fixContainerHeight();var i=this;this.modal.find("img").on("load",function(){i.fixContainerHeight()});var s=$("#modx-panel-resource").parent().scrollTop(),o=$("#moregallery-content").position().top,u=$("#modx-header").height(),a=s-o+u;a<150&&(a=150);this.modal.css("top",a)},fixContainerHeight:function(){if(this.modal){var e=this.modal.height(),t=this.modal.position().top,n=e+t,r=this.$el.find("#mgresource-imagearea").height();r<n&&this.$el.find("#mgresource-imagearea").height(n)}},modelStopEdit:function(){if(this.modal){var e=this;this.modal.fadeOut({complete:function(){e.modal=null;e.$el.find("#mgresource-imagearea").height("auto")}});this.modalMask.fadeOut();if(window.tinyMCE){var t=tinyMCE.get("mgimage-description");t&&t.remove()}}},updateFromModal:function(){var e=!1,t=[{name:"mgimage-name",key:"name"},{name:"mgimage-description",key:"description"},{name:"mgimage-url",key:"url"}],n=this,r=n.$el.find("#mgresource-modal .save");$.each(t,function(t,r){var i="",s=n.$("#mgresource-modal #"+r.name),o=n.activeModelInModal.get(r.key);s&&(i=s.val());if(i!=o){e=!0;n.activeModelInModal.set(r.key,i)}});if(e){r.text(moreGallery.lang("saving")).addClass("mgimage-saving");n.activeModelInModal.save(null,{success:function(){var e=new Date,t=e.getHours(),n=e.getMinutes(),i=e.getSeconds();t<10&&(t="0"+t.toString());n<10&&(n="0"+n.toString());i<10&&(i="0"+i.toString());var s=t+":"+n+":"+i;r.text(moreGallery.lang("saved_at",{time:s})).removeClass("mgimage-saving")}})}},updateCount:function(e,t){this.$("#mgresource-image-count").html(t.length);this.doSortable()},sortInitialized:!1,isSortableDrop:!1,doSortable:function(){if(!this.sortInitialized){var e=this;this.$("#mgresource-imagelist").sortable({placeholder:"sortable-placeholder",update:function(t,n){e.isSortableDrop=!1;$(this).find("li > div").each(function(e){var t=$(this).data("id"),n=imageCollection.get(t);if(n.get("sortorder")!=e+1){n.set({sortorder:e+1},{silent:!0});n.save()}})},forcePlaceholderSize:!0,forceHelperSize:!0});this.sortInitialized=!0}},startLoading:function(){$("#mgresource-imagearea").css("opacity",.2);$(".mgresource-loading").show()},doneLoading:function(){$(".mgresource-loading").hide();$("#mgresource-imagearea").css("opacity",1)},initializeUpload:function(){var e=this;$(document).bind("drop dragover",function(e){e.preventDefault()});$(document).bind("dragenter",function(){e.isSortableDrop||e.$el.addClass("mgresource-drag-entered")});$(document).bind("drop dragend",function(){e.$el.removeClass("mgresource-drag-entered")});var t=0;$("#mgresource-upload-input").fileupload({url:moreGallery.config.connector_url+"?action=mgr/images/upload",dataType:"json",dropZone:$("#mgresource-backbone-wrapper"),pasteZone:!1,progressInterval:250,paramName:"upload",add:function(n,r){if(r.files[0].size>moreGallery.config.memory_limit/12&&!confirm(moreGallery.lang("preupload_very_big",{file:r.files[0].name})))return;t++;var i=new Image({id:"tmp"+t,filename:r.files[0].name,mgr_thumb:moreGallery.config.assets_url+"mgr/img/uploading.png",file_url:moreGallery.config.assets_url+"mgr/img/uploading.png",name:r.files[0].name,sortorder:e.collection.length});e.collection.add(i);r.context=i.cid;var s=e.$("div[data-id="+r.context+"]");s&&s.addClass("mgimage-uploading");if(r.files[0].size<7e5&&window.FileReader){var o=new FileReader;o.onload=function(e){s.find(".image img").attr("src",e.target.result)};o.readAsDataURL(r.files[0])}setTimeout(function(){r.submit()},1e3)},done:function(t,n){var r=e.collection.get(n.context);if(r)if(n.result.success){var i=n.result.object;$.each(i,function(e,t){r.set(e,t)});r.trigger("uploadComplete")}else{var s=moreGallery.lang("upload_error",{file:r.attributes.filename,message:n.result.message});n.files[0].size>1572864&&(s+="\n\n"+moreGallery.lang("upload_error_huge",{size:(n.files[0].size/1048576).toFixed(2)}));alert(s);r.trigger("destroy")}else{alert(moreGallery.lang("model_error"));console&&console.error("Could not find model: ",n.context,e.collection.get(n.context))}},fail:function(t,n){var r=e.collection.get(n.context);r&&r.trigger("destroy");var i=moreGallery.lang("upload_error",{file:r.attributes.filename,message:n.errorThrown});n.files[0].size>1572864&&(i+="\n\n"+moreGallery.lang("upload_error_huge",{size:(n.files[0].size/1048576).toFixed(2)}));alert(i)},formData:function(){return[{name:"resource",value:MODx.request.id}]},progress:function(t,n){var r=parseInt(n.loaded/n.total*100,10),i=e.$("div[data-id="+n.context+"]");i&&i.find(".uploadprogress .bar").width(r+"%")}})}})});